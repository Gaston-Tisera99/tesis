var data=[],cant=0,boton=document.getElementById("agregar"),guardar=document.getElementById("procesarCompra");boton.addEventListener("click",agregar),guardar.addEventListener("click",save);const nombrePro=document.getElementById("buscar"),codigoPro=document.getElementById("codigo");function BuscarCodigo(e){e.preventDefault();const t=document.getElementById("codigo").value;"Enter"===e.key&&(nombrePro.disabled=!0,codigoPro.disabled=!0,$.ajax({url:"/api/buscar-producto",type:"POST",data:{id:t},success:function(e){const t=JSON.parse(e);t?(document.getElementById("nombre").value=t.nombre,document.getElementById("precio").value=t.precio,document.getElementById("id").value=t.id,document.getElementById("buscar").value="",document.getElementById("cantidad").focus()):(Swal.fire({icon:"error",title:"Error",text:"Codigo de producto inexistente",showConfirmButton:!1,timer:2e3}),document.getElementById("codigo").value="",document.getElementById("codigo").focus(),nombrePro.disabled=!1,codigoPro.disabled=!1)}}))}function buscarNombre(e){e.preventDefault();const t=document.getElementById("buscar").value;"Enter"==e.key&&(nombrePro.disabled=!0,codigoPro.disabled=!0,$.ajax({url:"/api/buscar-nombre",type:"POST",data:{nombre:t},success:function(e){const t=JSON.parse(e);t?(document.getElementById("codigo").value=t.codigo,document.getElementById("nombre").value=t.nombre,document.getElementById("precio").value=t.precio,document.getElementById("id").value=t.id,document.getElementById("cantidad").focus()):(Swal.fire({icon:"error",title:"Error",text:"Nombre de producto inexistente",showConfirmButton:!1,timer:2e3}),document.getElementById("codigo").value="",document.getElementById("buscar").value="",document.getElementById("buscar").focus(),nombrePro.disabled=!1,codigoPro.disabled=!1)}}))}function IngresarCantidad(e){e.preventDefault();const t=document.getElementById("cantidad").value,o=document.getElementById("precio").value;document.getElementById("sub_total").value=o*t}var cancel=document.getElementById("cancelar");function cancelar(){document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("buscar").value="",document.getElementById("proveedor").value="",nombrePro.disabled=!1,codigoPro.disabled=!1}function agregar(e){const t=document.getElementById("id").value,o=document.getElementById("codigo").value,d=document.getElementById("nombre").value,n=document.getElementById("cantidad").value,a=document.getElementById("precio").value,r=document.getElementById("sub_total").value;if(""===o||""===d||""===a||""===n)return Swal.fire({icon:"error",title:"Error",text:"No está permitido campos vacíos",showConfirmButton:!1,timer:2e3}),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",void(document.getElementById("sub_total").value="");data.push({id:cant,idProducto:t,codigo:o,nombre:d,precio:a,cantidad:n,total:r});var c="<tr id="+("row"+cant)+"><td>"+o+"</td><td>"+d+"</td><td>"+a+"</td><td>"+n+"</td><td>"+r+'</td><td><a href="#" class="btn btn-danger" style="margin-right: 10px;" onclick="eliminar('+cant+')";>Eliminar</a><a href="#" class="btn btn-warning" onclick="cantidad('+cant+')";>Cantidad</a></td></tr>';$("#tablaCompras tbody").append(c),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("buscar").value="",nombrePro.disabled=!1,codigoPro.disabled=!1,document.getElementById("buscar").focus(),cant++,sumar()}function sumar(){let e=0;for(x of data)e+=parseFloat(x.total);document.querySelector("#totalV").innerHTML=e}function cantidad(e){var t=parseFloat(prompt("Nueva Cantidad"));if(data[e].cantidad=t,isNaN(data[e].cantidad)||data[e].cantidad<=0)Swal.fire({icon:"error",title:"Error",text:"Elija una cantidad válida",showConfirmButton:!1,timer:2e3});else{data[e].total=data[e].cantidad*data[e].precio;var o=document.getElementById("row"+e);celda=o.getElementsByTagName("td"),celda[3].innerHTML=t,celda[4].innerHTML=data[e].total,sumar()}}function save(){var e=JSON.stringify(data),t=document.getElementById("proveedor").value,o=document.getElementById("totalV").textContent,d=parseFloat(o.match(/\d+(\.\d+)?/));console.log(t),""!==t.trim()?isNaN(d)||d<=0?mostrarAlerta("Error","Por favor, ingrese al menos un  producto.","error"):($.ajax({type:"POST",url:"/api/guardar-producto",data:{json:e,proveedor:t,monto:d}}).done((function(e){console.log(e),e?(mostrarAlerta("Éxito",e,"success"),Swal.fire({icon:"success",title:"Exito",text:"La venta se registro con exito!",showConfirmButton:!1,timer:2e3}),setTimeout(()=>{$("#lista tbody").empty(),$("#precioTotal").empty()},2e3)):mostrarAlerta("Error",e,"error")})),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("proveedor").value=""):mostrarAlerta("Error","Por favor, elija un proveedor válido.","error")}function eliminar(e){$("#row"+e).remove();var t=0,o=0;for(x of data)x.id==e&&(o=t),t++;data.splice(o,1),sumar()}function mostrarAlerta(e,t,o){Swal.fire(e,t,o)}cancel.addEventListener("click",cancelar);