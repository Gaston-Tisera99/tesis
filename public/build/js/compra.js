var data=[],cant=0,boton=document.getElementById("agregar"),guardar=document.getElementById("procesarCompra");function getCodigos(){let e=document.getElementById("campo").value,t=document.getElementById("list");if(e.length>0){let a="/api/buscar-productos",n=new FormData;n.append("campo",e),fetch(a,{method:"POST",body:n,mode:"cors"}).then(e=>e.json()).then(e=>{t.style.display="block",t.innerHTML=e}).catch(e=>console.log(e))}else t.style.display="none"}function mostrar(e,t,a,n){document.getElementById("list").style.display="none",document.getElementById("id").value=e,document.getElementById("codigo").value=t,document.getElementById("nombre").value=a,document.getElementById("precio").value=n,document.getElementById("cantidad").focus(),document.getElementById("campo").value=""}function IngresarCantidad(e){e.preventDefault();const t=document.getElementById("cantidad").value,a=document.getElementById("precio").value;document.getElementById("sub_total").value=a*t}boton.addEventListener("click",agregar),guardar.addEventListener("click",save),document.getElementById("campo").addEventListener("keyup",getCodigos);var cancel=document.getElementById("cancelar");function cancelar(){document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("proveedor").value=""}function agregar(e){const t=document.getElementById("id").value,a=document.getElementById("codigo").value,n=document.getElementById("nombre").value,o=document.getElementById("cantidad").value,d=document.getElementById("precio").value,r=document.getElementById("sub_total").value;if(""===a||""===n||""===d||""===o)return Swal.fire({icon:"error",title:"Error",text:"No está permitido campos vacíos",showConfirmButton:!1,timer:2e3}),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",void(document.getElementById("sub_total").value="");data.push({id:cant,idProducto:t,codigo:a,nombre:n,precio:d,cantidad:o,total:r});var l="<tr id="+("row"+cant)+"><td>"+a+"</td><td>"+n+"</td><td>"+d+"</td><td>"+o+"</td><td>"+r+'</td><td><a href="#" class="btn btn-danger" style="margin-right: 10px;" onclick="eliminar('+cant+')";>Eliminar</a><a href="#" class="btn btn-warning" onclick="cantidad('+cant+')";>Cantidad</a></td></tr>';$("#tablaCompras tbody").append(l),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",cant++,sumar()}function sumar(){let e=0;for(x of data)e+=parseFloat(x.total);document.querySelector("#totalV").innerHTML=e}function cantidad(e){var t=parseFloat(prompt("Nueva Cantidad"));if(data[e].cantidad=t,isNaN(data[e].cantidad)||data[e].cantidad<=0)Swal.fire({icon:"error",title:"Error",text:"Elija una cantidad válida",showConfirmButton:!1,timer:2e3});else{data[e].total=data[e].cantidad*data[e].precio;var a=document.getElementById("row"+e);celda=a.getElementsByTagName("td"),celda[3].innerHTML=t,celda[4].innerHTML=data[e].total,sumar()}}function save(){var e=JSON.stringify(data),t=document.getElementById("proveedor").value,a=document.getElementById("totalV").textContent,n=parseFloat(a.match(/\d+(\.\d+)?/));console.log(t),""!==t.trim()?isNaN(n)||n<=0?mostrarAlerta("Error","Por favor, ingrese al menos un  producto.","error"):($.ajax({type:"POST",url:"/api/guardar-producto",data:{json:e,proveedor:t,monto:n}}).done((function(e){console.log(e),e?(mostrarAlerta("Éxito",e,"success"),Swal.fire({icon:"success",title:"Exito",text:"La compra se registro con exito!",showConfirmButton:!1,timer:2e3}),setTimeout(()=>{$("#tablaCompras tbody").empty(),$("#precioTotal").empty()},2e3)):mostrarAlerta("Error",e,"error")})),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("proveedor").value=""):mostrarAlerta("Error","Por favor, elija un proveedor válido.","error")}function eliminar(e){$("#row"+e).remove();var t=0,a=0;for(x of data)x.id==e&&(a=t),t++;data.splice(a,1),sumar()}function mostrarAlerta(e,t,a){Swal.fire(e,t,a)}cancel.addEventListener("click",cancelar);