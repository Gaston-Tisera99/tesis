var data=[],cant=0,boton=document.getElementById("agregar"),guardar=document.getElementById("guardar");boton.addEventListener("click",agregar),guardar.addEventListener("click",save);const codigoPro=document.getElementById("codigo");function getCodigos(){let e=document.getElementById("campo").value,t=document.getElementById("list");if(e.length>0){let a="/api/buscar-productos",n=new FormData;n.append("campo",e),fetch(a,{method:"POST",body:n,mode:"cors"}).then(e=>e.json()).then(e=>{t.style.display="block",t.innerHTML=e}).catch(e=>console.log(e))}else t.style.display="none"}function mostrar(e,t,a,n){document.getElementById("list").style.display="none",document.getElementById("id").value=e,document.getElementById("codigo").value=t,document.getElementById("nombre").value=a,document.getElementById("precio").value=n,document.getElementById("cantidad").focus(),document.getElementById("campo").value=""}function IngresarCantidad(e){e.preventDefault();const t=document.getElementById("cantidad").value,a=document.getElementById("precio").value;document.getElementById("sub_total").value=a*t}document.getElementById("campo").addEventListener("keyup",getCodigos);var cancel=document.getElementById("cancelar");function cancelar(){document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value=""}function agregar(){const e=document.getElementById("cantidad").value,t=document.getElementById("precio").value,a=document.getElementById("nombre").value,n=document.getElementById("id").value,o=document.getElementById("codigo").value;var d=t*e;if(""===o||""===a||""===t||""===e)return Swal.fire({icon:"error",title:"Error",text:"No está permitido campos vacíos",showConfirmButton:!1,timer:2e3}),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",void(document.getElementById("sub_total").value="");if(isNaN(e)||e<=0)Swal.fire({icon:"error",title:"Error",text:"Elija una cantidad válida",showConfirmButton:!1,timer:2e3});else{data.push({id:cant,idProducto:n,codigo:o,nombre:a,precio:t,cantidad:e,total:d});var l="<tr id="+("row"+cant)+"><td>"+o+"</td><td>"+a+"</td><td>"+t+"</td><td>"+e+"</td><td>"+d+'</td><td><a href="#" class="btn btn-danger" style="margin-right: 10px;" onclick="eliminar('+cant+')";>Eliminar</a><a href="#" class="btn btn-warning" onclick="cantidad('+cant+')";>Cantidad</a></td></tr>';$("#lista tbody").append(l),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",cant++,sumar()}}function sumar(){let e=0;for(x of data)e+=x.total;document.querySelector("#precioTotal").innerHTML="Total: "+e}function cantidad(e){var t=parseFloat(prompt("Nueva Cantidad"));if(isNaN(t)||t<=0)Swal.fire({icon:"error",title:"Error",text:"Elija una cantidad válida",showConfirmButton:!1,timer:2e3});else{data[e].cantidad=t,data[e].total=t*data[e].precio;var a=document.getElementById("row"+e);celda=a.getElementsByTagName("td"),celda[3].innerHTML=t,celda[4].innerHTML=data[e].total,sumar()}}function calcularPrecioTotal(e){var t=parseFloat(e.querySelector(".cantidad").value),a=parseFloat(e.querySelector(".precio").value);if(isNaN(t)||isNaN(a))e.querySelector(".precioTotal").value="";else{var n=t*a;e.querySelector(".precioTotal").value=n.toFixed(2)}}function save(){var e=JSON.stringify(data),t=document.querySelector("#cliente").value,a=document.getElementById("precioTotal").textContent,n=parseFloat(a.match(/\d+(\.\d+)?/));""!==t.trim()?isNaN(n)||n<=0?mostrarAlerta("Error","Por favor, ingrese al menos un  producto.","error"):($.ajax({type:"POST",url:"/api",data:{json:e,cliente:t,monto:n}}).done((function(e){console.log(e),e?(mostrarAlerta("Éxito",e,"success"),Swal.fire({icon:"success",title:"Exito",text:"La venta se registro con exito!",showConfirmButton:!1,timer:2e3}),setTimeout(()=>{$("#lista tbody").empty(),$("#precioTotal").empty()},2e3)):mostrarAlerta("Error",e,"error")})),document.getElementById("cantidad").value="",document.getElementById("precio").value="",document.getElementById("nombre").value="",document.getElementById("id").value="",document.getElementById("codigo").value="",document.getElementById("sub_total").value="",document.getElementById("cliente").value=""):mostrarAlerta("Error","Por favor, elija un cliente válido.","error")}function mostrarAlerta(e,t,a){Swal.fire(e,t,a)}function eliminar(e){$("#row"+e).remove();var t=0,a=0;for(x of data)x.id==e&&(a=t),t++;data.splice(a,1),sumar()}cancel.addEventListener("click",cancelar);